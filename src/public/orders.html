<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos | NanoStore Security</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="toast-container" class="fixed top-5 right-5 z-[200] space-y-3"></div>

    <nav class="bg-white shadow-sm border-b mb-8">
        <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600 tracking-tight cursor-pointer" onclick="location.href='/'">üõí NanoStore</h1>
            <a href="/" class="text-sm font-bold text-gray-500 hover:text-indigo-600 transition flex items-center gap-2">
                <span>üè†</span> Volver a la Tienda
            </a>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4">
        <div class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900">Historial de Compras</h1>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-400">
                        <tr>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider"># Pedido</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider">Producto</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider">Total</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider">Estado</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider">Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="orders-list" class="divide-y divide-gray-100 text-gray-700">
                        <tr>
                            <td colspan="5" class="p-12 text-center text-gray-400">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-500 border-t-transparent mb-2"></div>
                                <p>Cargando tus pedidos...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="empty-state" class="hidden p-16 text-center">
                <div class="text-6xl mb-4">üì¶</div>
                <h3 class="text-xl font-bold text-gray-800">No hay pedidos registrados</h3>
                <p class="text-gray-500 mb-6">Tu historial de compras aparecer√° aqu√≠ una vez que realices tu primer pedido.</p>
                <a href="/" class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Explorar Cat√°logo</a>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 font-medium transition-all duration-300 transform scale-100`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        async function loadOrders() {
            const token = localStorage.getItem('token');
            const list = document.getElementById('orders-list');
            const empty = document.getElementById('empty-state');

            if (!token) {
                showToast("Acceso denegado. Por favor inicia sesi√≥n.", "error");
                setTimeout(() => window.location.href = "/", 2000);
                return;
            }

            try {
                // CORRECCI√ìN: Se actualiza la ruta a /api/my-orders para coincidir con el servidor refactorizado
                const response = await fetch(`http://localhost:3000/api/my-orders`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    showToast("Tu sesi√≥n ha expirado", "error");
                    localStorage.removeItem('token');
                    localStorage.removeItem('userId');
                    setTimeout(() => window.location.href = "/", 2000);
                    return;
                }

                const orders = await response.json();
                
                if (!orders || orders.length === 0) {
                    list.parentElement.parentElement.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }

                list.innerHTML = orders.map(order => `
                    <tr class="hover:bg-indigo-50/50 transition-colors">
                        <td class="p-4 font-mono font-bold text-indigo-600">#${order.userOrderNumber || 'N/A'}</td>
                        <td class="p-4 font-semibold text-gray-900">${order.productName || 'Producto'}</td>
                        <td class="p-4 font-black text-gray-800">$${order.total_price}</td>
                        <td class="p-4">
                            <span class="px-3 py-1 text-[10px] rounded-full font-bold uppercase tracking-wider ${
                                order.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                            }">
                                ${order.status}
                            </span>
                        </td>
                        <td class="p-4 text-sm text-gray-400">${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error("Error al cargar pedidos:", error);
                showToast("Error de conexi√≥n con el servidor", "error");
                list.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-red-500">Error al cargar datos.</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>
</html>